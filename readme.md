# HomeGame - Backend

## Setup

1. Run `npm i`
2. Follow steps for [self-hosted database](#self-hosted) or [docker database](#docker) to setup your dev database.
3. Create a `.env` file in the root of the backend folder. See [`Env Setup`](#env-setup) portion of this doc.

## Env Setup

To prepare the development environment, you need files containing sensitive information for accessing backend services. These files are intentionally excluded due to their confidential nature. Additionally, this approach permits us to define variables tailored to the local environment, ensuring uniqueness across each developer's machine.

1. Create .env file
   - Inside the env file, add the following fields and populate them per your machine. These fields will be used to connect to your local or dockerized postgres instance (also found in `.env.example`):

## Self Hosted

You may run on your machine. Make sure you have postgres and pgadmin installed locally.

Replace the default `POSTGRES_HOST=db` (for use with docker containers) with `POSTGRES_HOST=localhost` and run `npm start` or `npm run watch` for development.

### Docker

---

We employ Docker to start several containers within your local environment, streamlining the development process and substituting certain system configurations with these containers.

### Run the app using Docker

---

1. Download and install docker.
2. Download and install docker-compose.
3. Create .env file as specified [here](#env-setup).
4. Run `npm run docker:up` to download, build, and start containers defined in docker-compose.yml. Note: terminating this command will stop the containers. Add -d to detach and run in background.
5. After this, docker will be running the backend, database, and pgadmin.
6. Go to the `pgadmin` container and select the container action `Open in Browser`. Use the `#PGADMIN` credentials set from your `.env`. You will need to setup the database.
7. Click `Add New Server`. You will now be able to input your settings to create the database. In the General tab, choose whatever name you like.
8. In the Connection tab, input the following from your enviroment variables:
   - The Host Name / Address => `POSTGRES_HOST`
   - Username => `POSTGRES_USER`
   - Password => `POSTGRES_PASSWORD`
9. Open up Docker and go to the CLI for backend container actions.
10. Run `npm run seed` to seed the tables in the database and you've up and running!

### Docker Scripts

---

You have at your disposal the following set of `docker-compose` commands to manage these containers effectively.

`npm run docker:up`
This command initiates the building and starting of Docker containers. It serves as the primary step when no containers are currently active. It takes care of downloading or constructing all required container images and subsequently launching the essential containers and networks. If needed, you can run it in the background by adding the `-d` flag.

`npm run docker:down`
Stop and remove Docker containers. Please exercise caution, as it will erase all data within the database and pgadmin. Use it when you require a fresh start or exclusively for the `backend` service.

`npm run docker:start`
This command restarts containers that were previously stopped.

`npm run docker:stop`
It halts previously created Docker containers without removing them from your system.

`npm run docker:restart`
This command effectively restarts all Docker services, essentially performing the same operation as `npm run docker:stop && npm run docker:start`.

`npm run docker:logs`
Use this command to monitor and print logs generated by Docker services.

`npm run docker:rebuild`
This command recompiles the services, or a specific service if indicated. Consider using it alongside the `backend` parameter, especially after modifying any .env variables.

`npm run docker:clean`
Similar to `npm run docker:down`, this command additionally removes orphan containers and all associated images linked to the services specified in [docker-compose.yml](docker/local/docker-compose.yml).

Please bear in mind that you can execute all these commands individually for each service. In other words, running `npm run docker:up <service_name>` will perform the designated action for the specified `<service_name>` (where `<service_name>` corresponds to one of the services listed in [docker-compose.yml](docker/local/docker-compose.yml)). Furthermore, detailed instructions for each command can be accessed by running `npm run docker:<command> --help`.

### Troubleshooting

Port in use trying to create a new postgres instance? You'll want to see what process is running on your port with `sudo lsof -i tcp:<PORT>`. For Postgres,run `sudo lsof -i tcp:5432` in your terminal to see what is running on the port you are trying to use.

It should return something like this:

| COMMAND   | PID  | USER | ...more columns ->  |
| --------- | ---- | ---- | ------------------- |
| something | 1337 | user | ... more columns -> |

Use the `PID` from the table to `sudo kill <PID>` in this case, `sudo kill 1337`. You can rerun the `lsof -i tcp:<PORT>` command again to verify the process has been killed. Once killed, you can try setup again via docker or self hosting.
